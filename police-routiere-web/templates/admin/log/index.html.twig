{% extends 'base.html.twig' %}

{% block title %}Logs d'Audit - Police Routière Guinée{% endblock %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_dashboard_admin') }}">
                            <i class="bi bi-speedometer2 me-2"></i>Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_admin_region_index') }}">
                            <i class="bi bi-geo-alt me-2"></i>Régions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_admin_brigade_index') }}">
                            <i class="bi bi-shield me-2"></i>Brigades
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_admin_report_index') }}">
                            <i class="bi bi-file-text me-2"></i>Rapports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_admin_export_users') }}">
                            <i class="bi bi-download me-2"></i>Export
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ path('app_admin_log_index') }}">
                            <i class="bi bi-journal-text me-2"></i>Logs
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Logs d'Audit</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{{ path('app_admin_log_errors') }}" class="btn btn-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>Erreurs
                        </a>
                    </div>
                    <div class="btn-group me-2">
                        <a href="{{ path('app_admin_log_export') }}" class="btn btn-success">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Flash Messages -->
            {% for type, messages in app.session.flashbag.all() %}
                {% for message in messages %}
                    <div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endfor %}

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Total Logs</h6>
                            <h3 class="text-primary">{{ totalLogs }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Erreurs</h6>
                            <h3 class="text-danger">
                                {% set errorCount = stats|filter(stat => stat.level == 'ERROR')|first %}
                                {{ errorCount.count ?? 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Avertissements</h6>
                            <h3 class="text-warning">
                                {% set warningCount = stats|filter(stat => stat.level == 'WARNING')|first %}
                                {{ warningCount.count ?? 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Info</h6>
                            <h3 class="text-info">
                                {% set infoCount = stats|filter(stat => stat.level == 'INFO')|first %}
                                {{ infoCount.count ?? 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Niveau</label>
                            <select name="level" class="form-select">
                                <option value="">Tous</option>
                                <option value="INFO" {{ filters.level == 'INFO' ? 'selected' : '' }}>Info</option>
                                <option value="WARNING" {{ filters.level == 'WARNING' ? 'selected' : '' }}>Warning</option>
                                <option value="ERROR" {{ filters.level == 'ERROR' ? 'selected' : '' }}>Error</option>
                                <option value="CRITICAL" {{ filters.level == 'CRITICAL' ? 'selected' : '' }}>Critical</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Action</label>
                            <select name="action" class="form-select">
                                <option value="">Toutes</option>
                                <option value="CREATE" {{ filters.action == 'CREATE' ? 'selected' : '' }}>Création</option>
                                <option value="UPDATE" {{ filters.action == 'UPDATE' ? 'selected' : '' }}>Modification</option>
                                <option value="DELETE" {{ filters.action == 'DELETE' ? 'selected' : '' }}>Suppression</option>
                                <option value="LOGIN" {{ filters.action == 'LOGIN' ? 'selected' : '' }}>Connexion</option>
                                <option value="LOGOUT" {{ filters.action == 'LOGOUT' ? 'selected' : '' }}>Déconnexion</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Entité</label>
                            <select name="entity" class="form-select">
                                <option value="">Toutes</option>
                                <option value="User" {{ filters.entity == 'User' ? 'selected' : '' }}>Utilisateur</option>
                                <option value="Region" {{ filters.entity == 'Region' ? 'selected' : '' }}>Région</option>
                                <option value="Brigade" {{ filters.entity == 'Brigade' ? 'selected' : '' }}>Brigade</option>
                                <option value="Controle" {{ filters.entity == 'Controle' ? 'selected' : '' }}>Contrôle</option>
                                <option value="Rapport" {{ filters.entity == 'Rapport' ? 'selected' : '' }}>Rapport</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Recherche</label>
                            <input type="text" name="search" class="form-control" value="{{ filters.search }}" placeholder="Rechercher...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date début</label>
                            <input type="date" name="date_from" class="form-control" value="{{ filters.date_from }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date fin</label>
                            <input type="date" name="date_to" class="form-control" value="{{ filters.date_to }}">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i>Filtrer
                            </button>
                            <a href="{{ path('app_admin_log_index') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Réinitialiser
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Logs Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Entité</th>
                                    <th>Utilisateur</th>
                                    <th>Niveau</th>
                                    <th>Description</th>
                                    <th>IP</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                    <tr>
                                        <td>
                                            <small>{{ log.createdAt|date('d/m/Y H:i:s') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ log.level == 'ERROR' ? 'danger' : log.level == 'WARNING' ? 'warning' : log.level == 'CRITICAL' ? 'danger' : 'info' }}">
                                                {{ log.action }}
                                            </span>
                                        </td>
                                        <td>{{ log.entity }}</td>
                                        <td>
                                            {% if log.user %}
                                                {{ log.user.email }}
                                            {% else %}
                                                <em>Système</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ log.level == 'ERROR' ? 'danger' : log.level == 'WARNING' ? 'warning' : log.level == 'CRITICAL' ? 'danger' : 'info' }}">
                                                {{ log.level }}
                                            </span>
                                        </td>
                                        <td>
                                            <small>{{ log.description|slice(0, 50) }}{% if log.description|length > 50 %}...{% endif %}</small>
                                        </td>
                                        <td>
                                            <small>{{ log.ipAddress }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ path('app_admin_log_show', {'id': log.id}) }}" class="btn btn-outline-primary" title="Voir">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <form method="post" action="{{ path('app_admin_log_delete', {'id': log.id}) }}" style="display: inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce log ?');">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ log.id) }}">
                                                    <button type="submit" class="btn btn-outline-danger" title="Supprimer">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <i class="bi bi-inbox me-2"></i>Aucun log trouvé
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if totalPages > 1 %}
                        <nav class="mt-3">
                            <ul class="pagination justify-content-center">
                                {% if currentPage > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path('app_admin_log_index', {page: currentPage - 1, ...filters}) }}">Précédent</a>
                                    </li>
                                {% endif %}

                                {% for i in max(1, currentPage - 2)..min(totalPages, currentPage + 2) %}
                                    <li class="page-item {{ i == currentPage ? 'active' : '' }}">
                                        <a class="page-link" href="{{ path('app_admin_log_index', {page: i, ...filters}) }}">{{ i }}</a>
                                    </li>
                                {% endfor %}

                                {% if currentPage < totalPages %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path('app_admin_log_index', {page: currentPage + 1, ...filters}) }}">Suivant</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>

            <!-- Cleanup Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-trash me-2"></i>Nettoyage des logs
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('app_admin_log_cleanup') }}">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Supprimer les logs de plus de</label>
                                <div class="input-group">
                                    <input type="number" name="days" class="form-control" value="90" min="7" max="365">
                                    <span class="input-group-text">jours</span>
                                </div>
                                <small class="text-muted">Minimum 7 jours, maximum 365 jours</small>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer les anciens logs ? Cette action est irréversible.');">
                                    <i class="bi bi-trash me-1"></i>Nettoyer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
